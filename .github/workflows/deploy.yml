name: Deploy to DigitalOcean

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script_stop: true
          command_timeout: 14m
          envs: SECRET_KEY,DB_PASSWORD,DROPLET_IP,OPENAI_API_KEY,STRIPE_SECRET_KEY,STRIPE_PUBLISHABLE_KEY,STRIPE_WEBHOOK_SECRET,DO_SPACES_KEY,DO_SPACES_SECRET
          script: |
            set -euo pipefail
            cd /opt/fitnessai

            echo "=== Pulling latest code ==="
            git fetch origin main
            git reset --hard origin/main

            echo "=== Writing .env.production ==="
            printf '%s\n' \
              "SECRET_KEY=${SECRET_KEY}" \
              "DEBUG=False" \
              "ALLOWED_HOSTS=${DROPLET_IP},localhost" \
              "DB_NAME=fitnessai" \
              "DB_USER=fitnessai_user" \
              "DB_PASSWORD=${DB_PASSWORD}" \
              "FRONTEND_URL=http://${DROPLET_IP}" \
              "NEXT_PUBLIC_API_URL=http://${DROPLET_IP}" \
              "CORS_ALLOWED_ORIGINS=http://${DROPLET_IP}" \
              "CSRF_TRUSTED_ORIGINS=http://${DROPLET_IP}" \
              "OPENAI_API_KEY=${OPENAI_API_KEY}" \
              "STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}" \
              "STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}" \
              "STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}" \
              "DO_SPACES_KEY=${DO_SPACES_KEY}" \
              "DO_SPACES_SECRET=${DO_SPACES_SECRET}" \
              "DO_SPACES_BUCKET=fitnessai-bucket" \
              "DO_SPACES_ENDPOINT=https://sfo3.digitaloceanspaces.com" \
              "DO_SPACES_REGION=sfo3" \
              > .env.production

            echo "=== Building and deploying ==="
            docker compose -f docker-compose.prod.yml --env-file .env.production up -d --build --remove-orphans

            echo "=== Waiting for services to be healthy ==="
            sleep 10

            echo "=== Reloading nginx config ==="
            docker exec fitnessai_nginx nginx -s reload

            echo "=== Running migrations ==="
            docker exec fitnessai_backend python manage.py migrate --noinput

            echo "=== Loading exercise bank ==="
            docker exec fitnessai_backend python manage.py loaddata workouts/fixtures/exercises.json

            echo "=== Service status ==="
            docker compose -f docker-compose.prod.yml ps

            echo "=== Cleaning up old images ==="
            docker image prune -f

            echo "=== Deploy complete ==="
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DROPLET_IP: ${{ secrets.DROPLET_IP }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          DO_SPACES_KEY: ${{ secrets.DO_SPACES_KEY }}
          DO_SPACES_SECRET: ${{ secrets.DO_SPACES_SECRET }}
